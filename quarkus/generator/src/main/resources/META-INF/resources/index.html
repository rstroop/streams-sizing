<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Prices</title>

  <!-- UIkit CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.11.1/dist/css/uikit.min.css" />

  <!-- UIkit JS -->
  <script src="https://cdn.jsdelivr.net/npm/uikit@3.11.1/dist/js/uikit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/uikit@3.11.1/dist/js/uikit-icons.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <style>
    .loading p {
      text-align: center;
    }

    p.uk-text-lead, th {
      text-align: center !important;
    }

    .loader {
      font-size: 20px;
      margin: 100px auto;
      width: 1em;
      height: 1em;
      border-radius: 50%;
      position: relative;
      text-indent: -9999em;
      -webkit-animation: load4 1.3s infinite linear;
      animation: load4 1.3s infinite linear;
      -webkit-transform: translateZ(0);
      -ms-transform: translateZ(0);
      transform: translateZ(0);
    }

    @-webkit-keyframes load4 {

      0%,
      100% {
        box-shadow: 0 -3em 0 0.2em, 2em -2em 0 0em, 3em 0 0 -1em, 2em 2em 0 -1em, 0 3em 0 -1em, -2em 2em 0 -1em, -3em 0 0 -1em, -2em -2em 0 0;
      }

      12.5% {
        box-shadow: 0 -3em 0 0, 2em -2em 0 0.2em, 3em 0 0 0, 2em 2em 0 -1em, 0 3em 0 -1em, -2em 2em 0 -1em, -3em 0 0 -1em, -2em -2em 0 -1em;
      }

      25% {
        box-shadow: 0 -3em 0 -0.5em, 2em -2em 0 0, 3em 0 0 0.2em, 2em 2em 0 0, 0 3em 0 -1em, -2em 2em 0 -1em, -3em 0 0 -1em, -2em -2em 0 -1em;
      }

      37.5% {
        box-shadow: 0 -3em 0 -1em, 2em -2em 0 -1em, 3em 0em 0 0, 2em 2em 0 0.2em, 0 3em 0 0em, -2em 2em 0 -1em, -3em 0em 0 -1em, -2em -2em 0 -1em;
      }

      50% {
        box-shadow: 0 -3em 0 -1em, 2em -2em 0 -1em, 3em 0 0 -1em, 2em 2em 0 0em, 0 3em 0 0.2em, -2em 2em 0 0, -3em 0em 0 -1em, -2em -2em 0 -1em;
      }

      62.5% {
        box-shadow: 0 -3em 0 -1em, 2em -2em 0 -1em, 3em 0 0 -1em, 2em 2em 0 -1em, 0 3em 0 0, -2em 2em 0 0.2em, -3em 0 0 0, -2em -2em 0 -1em;
      }

      75% {
        box-shadow: 0em -3em 0 -1em, 2em -2em 0 -1em, 3em 0em 0 -1em, 2em 2em 0 -1em, 0 3em 0 -1em, -2em 2em 0 0, -3em 0em 0 0.2em, -2em -2em 0 0;
      }

      87.5% {
        box-shadow: 0em -3em 0 0, 2em -2em 0 -1em, 3em 0 0 -1em, 2em 2em 0 -1em, 0 3em 0 -1em, -2em 2em 0 0, -3em 0em 0 0, -2em -2em 0 0.2em;
      }
    }

    @keyframes load4 {

      0%,
      100% {
        box-shadow: 0 -3em 0 0.2em, 2em -2em 0 0em, 3em 0 0 -1em, 2em 2em 0 -1em, 0 3em 0 -1em, -2em 2em 0 -1em, -3em 0 0 -1em, -2em -2em 0 0;
      }

      12.5% {
        box-shadow: 0 -3em 0 0, 2em -2em 0 0.2em, 3em 0 0 0, 2em 2em 0 -1em, 0 3em 0 -1em, -2em 2em 0 -1em, -3em 0 0 -1em, -2em -2em 0 -1em;
      }

      25% {
        box-shadow: 0 -3em 0 -0.5em, 2em -2em 0 0, 3em 0 0 0.2em, 2em 2em 0 0, 0 3em 0 -1em, -2em 2em 0 -1em, -3em 0 0 -1em, -2em -2em 0 -1em;
      }

      37.5% {
        box-shadow: 0 -3em 0 -1em, 2em -2em 0 -1em, 3em 0em 0 0, 2em 2em 0 0.2em, 0 3em 0 0em, -2em 2em 0 -1em, -3em 0em 0 -1em, -2em -2em 0 -1em;
      }

      50% {
        box-shadow: 0 -3em 0 -1em, 2em -2em 0 -1em, 3em 0 0 -1em, 2em 2em 0 0em, 0 3em 0 0.2em, -2em 2em 0 0, -3em 0em 0 -1em, -2em -2em 0 -1em;
      }

      62.5% {
        box-shadow: 0 -3em 0 -1em, 2em -2em 0 -1em, 3em 0 0 -1em, 2em 2em 0 -1em, 0 3em 0 0, -2em 2em 0 0.2em, -3em 0 0 0, -2em -2em 0 -1em;
      }

      75% {
        box-shadow: 0em -3em 0 -1em, 2em -2em 0 -1em, 3em 0em 0 -1em, 2em 2em 0 -1em, 0 3em 0 -1em, -2em 2em 0 0, -3em 0em 0 0.2em, -2em -2em 0 0;
      }

      87.5% {
        box-shadow: 0em -3em 0 0, 2em -2em 0 -1em, 3em 0 0 -1em, 2em 2em 0 -1em, 0 3em 0 -1em, -2em 2em 0 0, -3em 0em 0 0, -2em -2em 0 0.2em;
      }
    }
  </style>
</head>

<body>
  <div class="uk-container">
    <div class="uk-padding-small">
      <p class="uk-text-lead">Price List</p>
    </div>
    
    <div class="loading">
      <div class="loader uk-text-primary">Loading...</div>
      <p class="uk-text-meta">Waiting on first payload...</p>
    </div>
    
    <div class="main" style="display: none;">
      <p class="uk-text-meta uk-text-default">This list is generated from the Topic named "usd-prices", and updated when
        a matching
        entry from the "eur-prices" Topic is streamed to the UI. Stop the Kafka Streams application, and restart it
        after a few seconds to see what happens to the EUR columns.</p>
      <table style="margin-bottom: 2em; text-align: center;"
        class="uk-table uk-table-divider uk-table-striped uk-table-hover uk-table-small">
        <caption></caption>
        <thead>
          <tr>
            <th class="uk-table-expand">Timestamp</th>
            <th class="uk-table-expand">&dollar; / USD</th>
            <th class="uk-table-expand">&euro; / EUR</th>
            <th>UUID</th>
          </tr>
        </thead>
        <tbody id="table-rows"></tbody>
      </table>
    </div>
  </div>
</body>

<script>
  const tableRows = document.getElementById("table-rows")

  let usdSource, eurSource

  setupUsdSSE()
  setupEurSSE()

  function setupUsdSSE () {
    usdSource = new EventSource("/prices/usd/stream");

    usdSource.onerror = function (e) {
      console.error('USD SEE Error', e)
      if (usdSource.readyState !== EventSource.CLOSED) {
        usdSource.close()
      }

      // Wait a little and reconnect to the backend
      setTimeout(() => setupUsdSSE(), 1000)
    }

    usdSource.onmessage = function onUsdMsg(event) {
      // Make table visible, and hide the loading indicator
      document.querySelector('.main').style.display = ''
      document.querySelector('.loading').style.display = 'none'

      console.log('USD Event', event)

      const data = JSON.parse(event.data)


      const row = document.createElement('tr')
      const uuidEl = document.createElement('td')
      const tsEl = document.createElement('td')
      const usdEl = document.createElement('td')
      const eurEl = document.createElement('td')

      row.className = 'animate__animated animate__flash'
      row.id = `uuid-${data.uuid}`

      uuidEl.innerHTML = `${data.uuid}`
      tsEl.innerHTML = new Date().toLocaleString()
      usdEl.innerHTML = data.price
      eurEl.className = 'eur'

      row.append(tsEl, usdEl, eurEl, uuidEl)
      tableRows.prepend(row)

      if (tableRows.children.length > 15) {
        tableRows.removeChild(tableRows.lastChild)
      }
    };
  }

  function setupEurSSE () {
    eurSource = new EventSource("/prices/eur/stream");

    eurSource.onerror = function (e) {
      console.error('EUR SEE Error', e)
      if (eurSource.readyState !== EventSource.CLOSED) {
        eurSource.close()
      }

      // Wait a little and reconnect to the backend
      setTimeout(() => setupEurSSE(), 1000)
    }

    eurSource.onmessage = function onEurMsg(event) {
      // Kafka is fast, so we add a very small delay here! This is so viewers
      // can see that the EUR value arrives separately to the USD value.
      setTimeout(() => {
        console.log('EUR Event', event)

        const data = JSON.parse(event.data)

        const eurTd = document.querySelector(`#uuid-${data.uuid} .eur`)
        const row = document.querySelector(`#uuid-${data.uuid}`)

        if (!eurTd || !row) {
          console.error('failed to find matching USD row for EUR payload', data)
        }

        eurTd.innerHTML = data.price
        eurTd.className = 'animate__animated animate__rubberBand'
      }, 500)
    }
  }
  
</script>

</html>
